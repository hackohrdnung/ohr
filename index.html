<!DOCTYPE html>
<html>

<!--************************************************************************** -->
<!-- Head                                                                      -->
<!--************************************************************************** -->
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="user-scalable     = no, 
                                   initial-scale     = 1, 
                                   maximum-scale     = 1, 
                                   minimum-scale     = 1, 
                                   width             = device-width"/>
    <title>Gehörschutz Check</title>
    <!-- Externe Styles und Scripts  -->
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
    <script src="cordova.js"></script>
    <!-- Interne Styles und Scripts  -->
    <style>
        @font-face{
            font-family:        "Material Icons";
            font-style:         normal;
            font-weight:        400;
            src:                url(icons.woff) format("woff");
        }
        @font-face{
            font-family:        "Roboto";
            font-style:         normal;
            font-weight:        300;
            src:                url(fontR300.woff) format("woff");
        }
        @font-face{
            font-family:        "Roboto";
            font-style:         normal;
            font-weight:        400;
            src:                url(fontR400.woff) format("woff");
        }
        @font-face{
            font-family:        "Roboto";
            font-style:         italic;
            font-weight:        400;
            src:                url(fontR400i.woff) format("woff");
        }
        @font-face{
            font-family:        "Roboto";
            font-style:         normal;
            font-weight:        500;
            src:                url(fontR500.woff) format("woff");
        }
        @font-face{
            font-family:        "Roboto";
            font-style:         normal;
            font-weight:        700;
            src:                url(fontR700.woff) format("woff");
        }
        .header{
            background-color:   #222222;
            color:              #ffffff;
            margin:             0px;
            padding:            0px;
        }
        .material-icons{
            font-family:        "Material Icons";
            font-weight:        normal;
            font-style:         normal;
            font-size:          36px; 
            display:            inline-block;
            line-height:        1;
            text-transform:     none;
            letter-spacing:     normal;
            word-wrap:          normal;
            vertical-align:     top;
            padding-bottom:     4px;
            padding-top:        4px;
            white-space:        nowrap;
            direction:          ltr;
            -webkit-font-smoothing:  antialiased;
            text-rendering:          optimizeLegibility;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings:   "liga";
        }
        .narrowButton{
            margin:             0px;
            max-width:          60px;
            min-width:          60px;
            margin:             0px;
            width:              60px;
        }
        .headerButton{
            font-size:          1.3em;
            height:             50px;
            padding-top:        5px;
        }
        .playButton{
            font-size:          1.3em;
            height:             40px;
            margin:             0px;
            padding:            0px;
        }
        .title{
            padding-top:        5px;
            width:              calc(100% - 120px);
        }
        h1{
            font-size:          1.3em;
            font-weight:        400;
            margin:             0px;
            padding:            0px;
            padding-top:        10px;
            text-align:         center;
        }
        h2{
            font-size:          1.1em;
            font-weight:        400;
            margin:             0px;
            padding:            0px;
            padding-top:        30px;
            padding-bottom:     25px;
            text-align:         left;
        }
        p{
            font-size:          1.0em;
            font-weight:        400;
            margin:             0px;
            padding:            0px;
            text-align:         center;
        }
        md-slider[md-discrete]:not([disabled]):focus .md-sign,
        md-slider[md-discrete]:not([disabled]):focus .md-sign:after,
        md-slider[md-discrete]:not([disabled]).active .md-sign,
        md-slider[md-discrete]:not([disabled]).active .md-sign:after {
          opacity: 1;
          -webkit-transform: translate3d(0, 0, 0) scale(1);
          transform: translate3d(0, 0, 0) scale(1);
        }
        md-slider[md-discrete] .md-sign,
        md-slider[md-discrete] .md-sign:after {
          opacity: 1;
          -webkit-transform: translate3d(0, 0, 0) scale(1);
          transform: translate3d(0, 0, 0) scale(1);
        }
    </style>
    <script>
        //Media Plugin fertig laden
        document.addEventListener('deviceready', init, false);
        var isAndroid = false;
        function init() {
            if(device.platform.toLowerCase() === "android"){
                isAndroid = true;
            }
        }
        //AngularJS Material Script
        var app = angular.module("myApp", ["ngMaterial", "ngMessages"]);
        app.config(function($mdThemingProvider){
            $mdThemingProvider
                .theme("default")
                //.dark()
                .primaryPalette("orange")
                .accentPalette("cyan");
        });
        app.controller("myCtrl", function($scope, $mdDialog){
            $scope.media         = null;
            $scope.repeatID      = 0;
            $scope.sequenceID    = 0;
            $scope.stepID        = 0;
            $scope.showOSPlayBtn = true;
            $scope.new = function(){
                $scope.stopCheckOS();
                $scope.initCheckOS();
                try{
                    if($scope.media==null){
                        $scope.media = new Media($scope.getCordovaPath() + "4khz.mp3", 
                            function(){console.log("Success")}, 
                            function(error){console.log("Error: " + JSON.stringify(error))});
                    }
                }catch(error){
                    console.log("Keine Media-Bibliothek gefunden")
                }
            }
            $scope.info = function(){
                var confirm =   $mdDialog.confirm({onComplete: function(){}})
                    .title("Info")
                    .textContent("Bitte eine Distanz von 30cm einhalten")
                    .clickOutsideToClose(true)
                    .targetEvent(event)
                    .ok("Schliessen")
                $mdDialog.show(confirm).then(function(){
                });
            }
            $scope.getCordovaPath = function() {
                var path = window.location.pathname;
                if(isAndroid){
                    path = "/android_asset/www/";
                }
                return 'file://' + path;
            }
            //1sek Sound in gewünschter Lautstärke wiedergeben
            $scope.playSound = function(volume){
                if($scope.media){
                    //$scope.media.setVolume(volume / 100);
                    $scope.media.setVolume('1.0');
                    $scope.media.play();
                }
            };

            //--------------------------------------------------------------------
            //Messung ohne Gehörschutz
            //--------------------------------------------------------------------
            $scope.initCheckOS = function(){
                //Lautstärke
                $scope.volumeOS = 100;
                //Lautstärke Backup (Wenn der Benuzter den Slider verschiebt...)
                $scope.volumeOSBackup = $scope.volumeOS;
                //Neue Sequenz starten
                $scope.sequenceID++;
            }
            $scope.initCheckOS();
            //Prüfsequenz starten
            $scope.startCheckOS = function() {
                $scope.showOSPlayBtn = false;
                $scope.stepID        = 1;
                $scope.initCheckOS();
                $scope.checkOS($scope.sequenceID, 0);
            };
            //Prüfsequenz stoppen
            $scope.stopCheckOS = function() {
                $scope.showOSPlayBtn = true;
                $scope.sequenceID++;
                if($scope.volumeMS && $scope.volumeOS!=100){
                    $scope.stepID = 3;
                }else{
                    $scope.stepID = 2;
                }
                if($scope.media){
                    $scope.media.stop();
                }
            };
            //Prüfsequenz durchführen
            $scope.checkOS = function(mySequenceID, myRepeatID) {
                //Prüfe, ob in aktueller Sequenz oder ob noch in alter Sequenz
                if($scope.sequenceID!=mySequenceID){
                    return;
                }
                //Wiederholung übernehmen
                $scope.repeatID = myRepeatID;
                //Rekursiv die Lautstärke schrittweise reduzieren
                setTimeout(function() {
                    //Prüfe, ob in aktueller Sequenz oder ob noch in alter Sequenz
                    if($scope.sequenceID!=mySequenceID){
                        return;
                    }
                    //Rekursiv 3mal nacheinander einen Ton in der gleichen Lautstärke
                    //ausgeben und dann die Lautstärke um den nächsten Schritt reduzieren
                    $scope.playSound($scope.volumeOS);
                    if($scope.repeatID>2){
                        if($scope.volumeOS<=0){
                            return;
                        } 
                        $scope.decreaseOS();
                        $scope.$apply();
                        $scope.repeatID = 0;    
                    }
                    $scope.repeatID++;
                    $scope.$apply();
                    $scope.checkOS(mySequenceID, $scope.repeatID);
                }, 1500);
            };
            //Lautstärke reduzieren
            $scope.decreaseOS = function() {
                $scope.volumeOS -= 10;
                $scope.volumeOSBackup = $scope.volumeOS;
            };
            //Wenn der Benutzer den Slider verschiebt, dann sofort auf den alten 
            //Wert zurücksetzen
            $scope.onChangeSliderOS = function() {
                $scope.volumeOS = $scope.volumeOSBackup;
            };
        });
    </script>
</head>

<!--************************************************************************** -->
<!-- Body                                                                      -->
<!--************************************************************************** -->
<body ng-app="myApp" ng-controller="myCtrl" id="bodyID">
<md-content>

    <!--********************************************************************** -->
    <!-- Body: Header                                                          -->
    <!--********************************************************************** -->
    <div layout="row" layout-align="center" class="header">
        <div style="width: 60px;">
            <md-button aria-label = "New"
                       class      = "md-primary narrowButton headerButton"
                       ng-click   = "new()">Neu</md-button>
        </div>
        <div layout-align="center" class="title">
            <h1>Gehörschutz Check</h1>
        </div>
        <div style="width: 60px;">
            <md-button aria-label = "Info"
                       class      = "md-primary narrowButton headerButton"
                       ng-click   = "info()">Info</md-button>
        </div>
    </div>
    <md-divider></md-divider>

    <!--********************************************************************** -->
    <!-- Body: Ohne Gehörschutz                                                -->
    <!--********************************************************************** -->
    <div layout="row" layout-align="center">
        <h2>Ohne Gehörschutz</h2>
        <h2 ng-if="showOSPlayBtn">:&nbsp;{{volumeOS}}dB</h2>
    </div>
    <div layout="row" layout-align="center">
        <md-slider id         = "slider" 
                   aria-label = "volumeOS"
                   ng-model   = "volumeOS"
                   ng-change  = "onChangeSliderOS()"
                   class      = "md-primary slider" 
                   style      = "width: 300px; height: 35px;" 
                   min        = "0"
                   max        = "100" 
                   step       = "10"
                   ng-disabled = "showOSPlayBtn"
                   md-discrete
                   active> 
        </md-slider>
    </div>
    <div layout       = "row" 
         layout-align = "center" 
         ng-if        = showOSPlayBtn>
        <md-button ng-click="startCheckOS()" class="md-primary playButton">
            <i class="material-icons">play_arrow</i>
        </md-button>
    </div>
    <div layout       = "row" 
         layout-align = "center" 
         ng-if        = !showOSPlayBtn>
        <md-button ng-click="stopCheckOS()" class="md-primary playButton">
            <i class="material-icons">stop</i>
        </md-button>
    </div>
    <br/>
    <md-divider></md-divider>
    <br/>

    <!--********************************************************************** -->
    <!-- Body: Resultat                                                        -->
    <!--********************************************************************** -->
    <div layout="row" layout-align="center">
        <p>Lautstärke: {{volumeOS}}</p>
    </div>
    <div layout="row" layout-align="center">
        <p>StepID: {{stepID}}</p>
    </div>
    <div layout="row" layout-align="center">
        <p>SequenceID: {{sequenceID}}</p>
    </div>
    <div layout="row" layout-align="center">
        <p>repeatID: {{repeatID}}</p>
    </div>

</md-content>
</body>

</html>